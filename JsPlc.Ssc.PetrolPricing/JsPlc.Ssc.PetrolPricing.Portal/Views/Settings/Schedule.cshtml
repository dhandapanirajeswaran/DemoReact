@model JsPlc.Ssc.PetrolPricing.Models.ViewModels.Schedule.ScheduleViewModel
@using JsPlc.Ssc.PetrolPricing.Portal.Helper.Extensions
@using JsPlc.Ssc.PetrolPricing.Models.WindowsService
@{
    ViewBag.Title = "Email Schedules";

    var statusMessages = new Dictionary<WinServiceEventStatus, string>()
    {
        {WinServiceEventStatus.None, "" },
        {WinServiceEventStatus.Paused, "<span class='text-danger'><i class='fa fa-info'> Paused</i></span>" },
        {WinServiceEventStatus.Sleeping, "<span><i class='fa fa-info'> Sleeping</i></span>" },
        {WinServiceEventStatus.Running, "<span class='text-warning'><i class='fa fa-info'> Running</i></span>" },
        {WinServiceEventStatus.Success, "<span class='text-success'><i class='fa fa-check'> Success</i></span>" },
        {WinServiceEventStatus.Failed, "<span class='text-danger'><i class='fa fa-times'> Failed</i></span>" }
    };

    var eventTypeMessages = new Dictionary<WinServiceEventType, string>()
    {
        {WinServiceEventType.None, "None" },
        {WinServiceEventType.DailyPriceEmail, "Daily Price Email" }
    };
}

<h1>
    <i class="fa fa-cogs"> System Settings</i>

    <div class="pull-right">
        <button type="button" class="btn btn-warning" id="btnResetLastCompletedOn" data-infotip="Clear the [b]Last Completed On[/b] date[br /]This allows the [b]Schedule Email[/b] to be resent today"><i class="fa fa-eraser"></i> Clear Today</button>

        <button type="button" class="btn btn-primary" id="btnRunSchedule" data-infotip="Run the [b]Schedule[/b][br /][u]Note:[/u] This will [i]not[/i] run future items"><i class="fa fa-location-arrow"></i> Run Schedule</button>
    </div>
</h1>

<ul class="nav nav-tabs nav-condensed">
    <li><a href="@Url.Action("Index", "Settings")"><i class="fa fa-cogs"></i> Common Settings</a></li>
    <li><a href="@Url.Action("DriveTime", "Settings")"><i class="fa fa-clock-o"></i> Drive Time</a></li>
    <li><a href="@Url.Action("Brands", "Settings")"><i class="fa fa-apple"></i> Brands &amp; Grocers</a></li>
    <li class="active"><a href="@Url.Action("Schedule", "Settings")"><i class="fa fa-calendar"></i> Email Schedule</a></li>
    <li><a href="@Url.Action("PriceFreeze", "Settings")"><i class="fa fa-hourglass-start"></i> Price Freeze Events</a></li>
</ul>

<div>
    <div class="modal fade" id="EditScheduleItemModal" tabindex="-1" role="dialog" aria-labelledby="competitorPricesPopupLabel" style="display: none; width: 50em; margin: 2em auto;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">Edit Schedule Item</h4>
            </div>
            <div class="modal-body">

                <div id="divEditScheduleLoader" class="alert alert-info">
                    <i class="fa fa-clock-o pulse-opacity"></i> Loading. Please wait...
                </div>

                <table class="table table-condensed table-striped">
                    <tbody>
                        <tr>
                            <td class="text-right" style="width: 33%"><label>Event Type:</label></td>
                            <td><span class="event-type font125pc"></span></td>
                        </tr>
                        <tr>
                            <td class="text-right"><label>is Active:</label></td>

                            <td>
                                <label><input type="radio" name="radIsActive" id="radIsActiveYes" value="1" /> Yes</label>
                                <label style="margin-left: 4em;"><input type="radio" name="radIsActive" id="radIsActiveNo" value="0" /> No</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-right" ><label>Scheduled For:</label></td>
                            <td>
                                <div class="col-md-4">
                                <input type="time" name="txtScheduledForHour" class="form-control" id="txtScheduledForHour" value="18:00" data-infotip="Please enter a time [b]HH:MM[/b]" />
                                </div> (mm:ss)
                            </td>
                        </tr>
                        <tr>
                            <td class="text-right" ><label>Last Polled On:</label></td>
                            <td><span class="lastPolledOn"></span></td>
                        </tr>
                        <tr>
                            <td class="text-right" ><label>Last Started On:</label></td>
                            <td><span class="lastStartedOn"></span></td>
                        </tr>
                        <tr>
                            <td class="text-right" ><label>Last Completed On:</label></td>
                            <td><span class="lastCompletedOn"></span></td>
                        </tr>
                        <tr>
                            <td class="text-right" ><label>Status:</label></td>
                            <td><span class="status"></span></td>
                        </tr>

                        <tr>
                            <td class="text-right"><label>Email Address:</label></td>
                            <td><input type="email" id="txtEmailAddress" class="col-md-8 form-control mono-font" data-infotip="Please enter a [i]Sainsburys[/i] Email Address" /></td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert alert-info">
                    <i class="fa fa-info-circle fa-2x"></i>
                    Set a time in the past and use the <strong>Run Schedule</strong> button to test the schedule.
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" id="ScheduleItemModalUpdateButton" class="btn btn-success" data-infotip="Update the [b]Schedule Item[/b]"><i class="fa fa-check"></i> Update</button>
            </div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h4><i class="fa fa-calendar"></i> Scheduled Items </h4>
        </div>

        <div class="panel-body">
            <table class="table table-condensed table-striped">
                <thead>
                    <tr>
                        <th>Active</th>
                        <th>Event Type</th>
                        <th>Scheduled For</th>
                        <th>Email Address</th>
                        <th>Last Polled On</th>
                        <th>Last Started On</th>
                        <th>Last Completed On</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.ScheduledItems.Any())
                    {
                        <tr>
                            <td colspan="9" class="text-center text-danger font125pc">Found 0 scheduled items</td>
                        </tr>
                    }

                    @foreach (var row in Model.ScheduledItems)
                    {
                        var rowClass = row.IsActive ? "" : "row-inactive";
                        <tr class="@(rowClass)">
                            <td>
                                @if (row.IsActive)
                                {
                                    <span class="text-success"><i class="fa fa-check"></i> Yes</span>
                                }
                                else
                                {
                                    <span class="text-danger"><i class="fa fa-times"></i> No</span>
                                }
                            </td>
                            <td>@(eventTypeMessages[row.WinServiceEventTypeId])</td>
                            <td>@(Html.FormatFriendlyDateTime(row.ScheduledFor))</td>
                            <td>@if(row.EmailAddress != "")
                            {
                                <a href="mailto:@(row.EmailAddress)">@(row.EmailAddress)</a>
                            }
                            </td>
                            <td>@(Html.FormatFriendlyDateTime(row.LastPolledOn))</td>
                            <td>@(Html.FormatFriendlyDateTime(row.LastStartedOn))</td>
                            <td>@(Html.FormatFriendlyDateTime(row.LastCompletedOn))</td>
                            <td>@Html.Raw(statusMessages[row.WinServiceEventStatusId])</td>
                            <td>
                                <a role="button" href="#" class="btn btn-primary btn-sm" data-click="EditScheduleItem" data-item-id="@(row.WinServiceScheduleId)" data-toggle="modal" data-target="#EditScheduleItemModal" data-infotip="Edit this schedule item">
                                    <i class="fa fa-calendar"></i> Edit
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h4><i class="fa fa-list-alt"></i> Schedule Event Log
            <button type="button" id="btnClearEventLog" class="btn btn-danger pull-right" data-infotip="Remove all the [b]Event Log[/b] entries"><i class="fa fa-power-off"></i> Clear Event Log</button>
            </h4>
        </div>

        <div class="panel-body">
            <table class="table table-striped table-condensed">
                <thead>
                    <tr>
                        <th style="width: 10%">Created On</th>
                        <th style="width: 20%;"></th>
                        <th style="width: 10%">Event Status</th>
                        <th>Message</th>
                    </tr>
                </thead>

                <tbody>

                    @if (!Model.EventLogItems.Any())
                    {
                        <tr>
                            <td colspan="4" class="text-danger text-center font125pc">Found 0 Event Logs Entries.</td>
                        </tr>
                    }

                    @foreach (var row in Model.EventLogItems)
                    {
                        <tr>
                            <td class="text-center">@(Html.FormatFriendlyDateTime(row.CreatedOn))</td>
                            <td class="text-center">@(Html.FormatFriendlyTimeAgo(row.CreatedOn))</td>
                            <td class="text-center">@(Html.Raw(statusMessages[row.WinServiceEventStatusId]))</td>
                            <td><strong>@(row.Message)</strong></td>
                        </tr>
                        if (!String.IsNullOrEmpty(row.Exception))
                        {
                        <tr>
                            <td colspan="4">
                            <strong class="text-danger">Exception:</strong>
                            <div style="border: 4px solid #6f1f44; background: #ffeeee; margin: 0 0 1em 0; padding: 4px; width: 98%; overflow: auto;">
                                @(row.Exception)
                            </div>
                            </td>
                        </tr>
                            }
                        }
                </tbody>
            </table>
        </div>
    </div>
</div>


<script>
    require(["EmailSchedule","infotips"],
        function (emailSchedule, infotips) {
            emailSchedule.init();
        });
</script>
