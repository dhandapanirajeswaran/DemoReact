@{
    ViewBag.Title = "Site Prices";
}

<style type="text/css">
    .smaller-normal {
        font-size: smaller;
        font-weight: normal;
    }

    .smaller {
        font-size: smaller;
    }

    .input-override {
        padding-top: 1px;
        display: inline;
        width: 50px;
        height: 23px;
    }
</style>

<h1>Market comparison and planner</h1>
<hr />
<!-- knockout binds here -->
<div id="petrolpricingpage" >
    <!-- Email ALL popup within knockout -->
    <div class="modal fade" id="emailAllSites" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         data-bind="with: emailAllPopupSiteItemModel, visible: showEmailAllPopup">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Send Email to ALL Sites</h4>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to email <strong>ALL</strong> Sites their daily price update?</p>
                    <h5 style="color: red" data-bind="visible: pageHasUnsavedChanges">
                        The prices shown on screen are still UNSAVED.
                        The emails will NOT be sent with these unsaved prices.
                        If you wish to send these prices, please close this popup and click "Save Prices" first.
                    </h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-bind="click: emailAllCloseClick">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-dismiss="modal" data-bind="click: emailAllClick">Email All Sites</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END Email ALL popup within knockout -->
    <!-- Email popup within knockout -->
    <div class="modal fade" id="emailSite" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         data-bind="with: emailPopupSiteItemModel, visible: showEmailPopup">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Send Email</h4>
                    <h5 style="color: red" data-bind="visible: pageHasUnsavedChanges">The prices shown are UNSAVED. The email will NOT be sent with these unsaved prices. If you wish to send these prices, please close this popup and click "Save Prices" first.</h5>
                </div>
                <div class="modal-body smaller">
                    <h2 style="visibility: hidden; display: none">
                        kSiteName:<span data-bind="text: kSiteName"></span>
                        kStartDateMonthYear:<span data-bind="text: kStartDateMonthYear"></span>
                        kUnleadedPrice:<span data-bind="text: kUnleadedPrice"></span>
                        kDieselPrice:<span data-bind="text: kDieselPrice"></span>
                        showEmailSiteButton:<span data-bind="text: showEmailSiteButton"></span>
                        <input type="button" data-bind="click: emailSendClick" value="Test send click" />
                    </h2> <!-- debug view -->
                    <h1>FAO Store/duty manager - URGENT FUEL PRICE CHANGE</h1>
                    <p>Queries to the Trading Hotline using Option 1 Trading, Option 2 Grocery and Option 8 Petrol and Kiosk </p>
                    <h2><span id="kSiteName" data-bind="text: kSiteName"></span></h2>
                    <p>
                        <strong>
                            Petrol price changes, effective end of trade
                            <span id="kStartDateMonthYear" data-bind="text: kStartDateMonthYear"></span>
                        </strong>
                    </p>
                    <table>
                        <tr><td><strong>Product</strong></td><td><strong>New Price</strong></td></tr>
                        <tr><td>Unleaded&nbsp;</td><td>&nbsp;<span id="kUnleadedPrice" data-bind="text: kUnleadedPrice"></span></td></tr>
                        <tr><td>Super (if applicable)&nbsp;</td><td>&nbsp;<span id="kSuperPrice" data-bind="text: kSuperPrice"></span></td></tr>
                        <tr><td>Diesel&nbsp;</td><td>&nbsp;<span id="kDieselPrice" data-bind="text: kDieselPrice"></span></td></tr>
                    </table>
                    <br />
                    <ul>
                        <li>All fuel price changes must be actioned at the end of trade only</li>
                        <li>Colleague actioning the price change must ensure the changes have applied on the pumps, enter the time of the change and then sign as confirmation before filing this message at the PFS</li>
                        <li>Ensure you enter the new prices correctly into REPOS e.g. If the price is 129.90ppl, then enter 129.90 in the new price field (make sure there are no fuel sales outstanding on the REPOS system or pumps before making the price change, <strong>ALL</strong> working pumps <strong>MUST</strong> be left <strong>ON</strong> and nozzle placed in the pump holders)</li>
                        <li>You are reminded that only fuel price changes sent to you by email should be actioned. Please ignore REPOS price change reports.</li>
                    </ul>
                    <h3>24 hour sites</h3>
                    <ul>
                        <li>Action the price change in conjunction with the REPOS EOD routine between midnight and 2am. Colleague actioning the price change must ensure that the changes have applied on the pumps, enter the time of the change and then sign as confirmation before filing this message at the PFS.</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <h5 style="color: red" data-bind="visible: pageHasUnsavedChanges">The prices shown are UNSAVED. The email will NOT be sent with these unsaved prices. If you wish to send these prices, please close this popup and click "Save Prices" first.</h5>
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-bind="click: hideEmailPopup">Cancel</button>
                    <input type="button" class="btn btn-primary" value="Email Site"
                           id="EmailSiteButton" onclick="" data-dismiss="modal" data-bind="visible: showEmailSiteButton, click: emailSendClick" />
                </div>
            </div>
        </div>
    </div>
    <!-- End Email popup within knockout -->
    <!-- Submit disabled, all work done thru ajax calls -->
    <form id="myform" method="post" data-bind="submit: savePetrolPricingForm" xclass="input-group-sm" action="sites/PostPrices" onsubmit="    return false;" onclick="    IsSitePriceFormClicked=1; " >
        <div class="row">
            <!-- Date Picker -->
            <div class="col-md-1">
                <label for="viewingDate">Date:</label>
                <input type="text" id="viewingDate" class="datepicker form-control"
                       style="width: 85px" name="viewingDate" maxlength="12"
                       data-bind="value: $root.InitDate" />
            </div>
            <!-- Store No -->
            <div class="col-md-2">
                <label for="viewingStoreNo">Store No:</label>
                <input type="text" id="viewingStoreNo" class="form-control" maxlength="9"
                       name="viewingStoreNo" data-bind="numeric, value: $root.StoreNo" />
            </div>
            <!-- Store Name -->
            <div class="col-md-2">
                <label for="viewingStoreName">Store Name:</label>
                <input type="text" id="viewingStoreName" class="form-control" maxlength="50"
                       name="viewingStoreName" data-bind="value: $root.StoreName" />
            </div>
            <!-- Store Town -->
            <div class="col-md-2">
                <label for="viewingStoreTown">Store Town:</label>
                <input type="text" id="viewingStoreTown" class="form-control" maxlength="50"
                       name="viewingStoreTown" data-bind="value: $root.StoreTown" />
            </div>
            <!-- Catalist No -->
            <div class="col-md-2">
                <label for="viewingCatNo">Catalist No:</label>
                <input type="text" id="viewingCatNo" class="form-control" maxlength="9"
                       name="viewingCatNo" data-bind="numeric, value: $root.CatNo" />
            </div>
            <!-- go button -->
            <div class="col-md-1">
                <button style="margin-top: 24px" type="button" class="btn btn-success" data-bind="click: loadPageWithParams">Go</button>
            </div>
            <!-- show all button -->
            <div class="col-md-1">
                <button style="margin-top: 24px" type="button" class="btn btn-default" data-bind="click: function() { reloadSearchPage('Sites/Prices?date='+$root.InitDateInUsFormat()) }">Show all</button>
            </div>
        </div>

        <hr />
        <div style="display: none" class="alert alert-danger" data-bind="visible: $root.HasValidationErrors() || $root.HasErrorMessage()">
            <div class="col-md-1 text-center"><i class="fa fa-exclamation-triangle fa-2x"></i></div>
            <div class="col-md-8" style="padding-top: 2px"><strong><span id="msgError"></span></strong></div>
            <div class="clearfix"></div>
        </div>
        <div style="display: none" class="alert alert-warning" data-bind="visible: !$root.hasAnyFieldErrors() && !$root.HasValidationErrors() && $root.HasUnsavedChanges() && !$root.ViewingHistorical() && !$root.hasBadPriceChangeValue()">
            <div class="col-md-1 text-center"><i class="fa fa-question-circle fa-2x"></i></div>
            <div class="col-md-5">
                <strong>
                    You have unsaved changes. Would you like to save them?
                </strong>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-success" data-bind="click: savePetrolPricingForm">
                    Yes
                </button>
            </div>
            <div class="clearfix"></div>
        </div>
        <div style="display: none" class="alert alert-success" data-bind="visible: $root.HasSuccessMessage()">
            <div class="col-md-1 text-center"><i class="fa fa-exclamation-triangle fa-2x"></i></div>
            <div class="col-md-4" style="padding-top: 2px"><span id="msgSuccess"></span></div>
            <div class="clearfix"></div>
        </div>

        <div style="display: none;" class="alert alert-danger" data-bind="visible: $root.hasBadPriceChangeValue()">
            <div class="col-md-1 text-center"><i class="fa fa-exclamation-triangle fa-2x"></i></div>
            <div class="col-md-10">
                <strong>Please enter a valid value for the price change for <span id="msgFuelTypeError"></span>.</strong>
            </div>
            <div class="col-md-1 pull-right">
                <span class="clickable btn btn-default" data-bind="click:closeWarningPanel">
                    <i class="fa fa-close"></i> Close
                </span>
            </div>
            <div class="clearfix"></div>
        </div>

        <div style="display:none;" class="alert alert-danger" data-bind="visible: $root.hasAnyFieldErrors() && !$root.HasValidationErrors()">
            <div class="col-md-1 text-center"><i class="fa fa-exclamation-triangle fa-2x"></i></div>
            <div class="col-md-10">
                <strong>There are 1 or more field errors. Please correct and retry.</strong>
            </div>
            <div class="clearfix"></div>
        </div>

        <div style="display:block;" class="alert alert-warning busy-loader" data-bind="visible: $root.busyLoadingData()">
            <div class="col-md-1 text-center"><i class="fa fa-clock-o fa-2x"></i></div>
            <div class="col-md-10 text-center">
                <strong>Loading Sales Pricing information. Please wait...</strong>
            </div>
            <div class="clearfix"></div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover" id="accordion">
                <!-- HEADINGS -->
                <thead>
                    <tr data-bind="visible: !$root.ViewingHistorical()">
                        <th colspan="7">
                            <!-- Price Change Type -->
                            <div class="col-md-4" style="margin-left: -10px"><b>Price change type:</b></div>
                            <div class="col-md-4">
                                <label class="radio-button"><input type="radio" value="(+/-n)" data-bind="click: switchChangeType, checked: changeType" /> (+/-n)</label>&nbsp;&nbsp;
                                <label class="radio-button"><input type="radio" value="Override all" data-bind="click: switchChangeType, checked: changeType" /> Override all</label>
                            </div>
                        </th>
                        <th colspan="2">
                            <span class="smaller-normal">
                                <span style="display: inline-block; width: 55px" data-bind="text: changeType"></span>
                                <input type="text" class="form-control input-override" maxlength="8" data-bind="value: $root.unleadedOffset" />
                                <input type="button" class="btn btn-default btn-xs btn-go" value="Go" data-bind="click: changePricePerLitreUnleaded" />
                            </span>
                        </th>
                        <th colspan="2">
                            <span class="smaller-normal">
                                <span style="display: inline-block; width: 55px" data-bind="text: changeType"></span>
                                <input type="text" class="form-control input-override" maxlength="8" data-bind="value: $root.dieselOffset" />
                                <input type="button" class="btn btn-default btn-xs btn-go" value="Go" data-bind="click: changePricePerLitreDiesel" />
                            </span>
                        </th>
                        <th colspan="2">
                            <span class="smaller-normal">
                                <span style="display: inline-block; width: 55px" data-bind="text: changeType"></span>
                                <input type="text" class="form-control input-override" maxlength="8" data-bind="value: $root.superOffset" />
                                <input type="button" class="btn btn-default btn-xs btn-go" value="Go" data-bind="click: changePricePerLitreSuper" />
                            </span>
                        </th>
                    </tr>
                    <!-- 13 column layout -->
                    <tr rowspan="2" style="background-color: silver">
                        <th><span>#</span></th>
                        <th><span>Store No.</span></th>
                        <th><span></span></th>
                        <th><span>Store Name</span></th>
                        <th><span>Store Town</span></th>
                        <th><span>Cat No.</span></th>
                        <th><span>PFS No.</span></th>

                        <th width="200" colspan="2" class="text-center" style="border-left: 1px solid #ccc">
                            <h4>
                                <span class="label label-success">
                                    &nbsp;Unleaded&nbsp;
                                </span>
                            </h4>
                        </th>
                        <th width="200" colspan="2" class="text-center" style="border-left: 1px solid #ccc">
                            <h4>
                                <span class="label label-black">&nbsp;Diesel&nbsp;</span>
                            </h4>
                        </th>
                        <th width="200" colspan="2" class="text-center" style="border-left: 1px solid #ccc">
                            <h4>
                                <span class="label label-success-inverted">&nbsp;Super Unleaded&nbsp;</span>
                            </h4>
                        </th>
                    </tr>
                    <tr>
                        <!-- 13 column layout -->
                        <th></th>
                        <th colspan="3">
                            <!-- EMAIL all Button, only loads popup -->
                            <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#emailAllSites"
                                    data-bind="visible: !$root.ViewingHistorical() && $root.dataAvailable() == true">
                                Email all &nbsp;<i class="fa fa-envelope-o"></i>
                            </button>
                        </th>
                        <th colspan="3"></th>
                        <th width="60" style="border-left: 1px solid #ddd"><span>Today</span></th>
                        <th width="140" style="border-left: 1px solid #ddd"><span>Tomorrow</span></th>
                        <th width="60" style="border-left: 1px solid #ddd"><span>Today</span></th>
                        <th width="140" style="border-left: 1px solid #ddd"><span>Tomorrow</span></th>
                        <th width="60" style="border-left: 1px solid #ddd"><span>Today</span></th>
                        <th width="140" style="border-left: 1px solid #ddd"><span>Tomorrow</span></th>
                    </tr>
                </thead>
                <tbody data-bind="with: dataModel">
                    <!-- JS Store DataRows -->
                    <!-- ko foreach: sites -->
                    <tr class="panel-heading" role="tab" data-bind="id:('Heading' + SiteId)">
                        <td>
                            <a   role="button" data-toggle="collapse" data-parent="#accordion"
                               data-bind="attr:{href:('#CollapseCompetitorsforsite' + SiteId)}, click: getCompetitorDataClick"><i  class="fa fa-minus-square-o" data-bind="css: showingComps() ? 'fa fa-minus-square-o' : 'fa fa-plus-square-o'"></i></a>
                        </td>
                        <td><span data-bind="text: StoreNo"></span></td>
                        <!-- Email envelope... -->
                        <td>
                            <span>
                                <a href="#" data-toggle="modal" data-target="#emailSite" data-bind="click: bindEmailTemplate">
                                    <i class="fa fa-envelope-o" data-bind="visible: canSendEmail()"></i>
                                    <!-- ko if: hasEmailSendLogEntry() -->
                                    <!-- ko with: EmailSendLogEntry -->
                                    <i class="fa fa-check" data-bind="visible: IsSuccess, attr: {title:'Email sent..'}" style="color: green"></i>
                                    <i class="fa fa-warning" data-bind="visible: IsWarning, attr: {title:WarningMessage}" style="color: orange"></i>
                                    <i class="fa fa-ban" data-bind="visible: IsError, attr: {title:ErrorMessage}" style="color: red"></i>
                                    <!-- /ko -->
                                    <!-- /ko -->
                                </a>
                            </span>
                        </td>
                        <td><span data-bind="text: StoreName"></span></td>
                        <td><span data-bind="text: Town"></span></td>
                        <td><span data-bind="text: CatNo"></span></td>
                        <td><span data-bind="text: PfsNo"></span></td>

                        <!-- ko foreach: FuelPricesToDisplay -->
                        <!-- ko if: siteSupportsFuel -->
                        <td style="border-left: 1px solid #ddd">
                            <span data-bind="text: FuelPrice.TodayPrice"></span>
                        </td>
                        <td style="border-left: 1px solid #ddd">
                            &nbsp;<span data-bind="attr:{title:(FuelPrice.IsTrailPrice ? 'Trail price: ' + FuelPrice.CompetitorName : 'Competitor name: ' + FuelPrice.CompetitorName + '; Markup: ' + FuelPrice.Markup)}, text: FuelPrice.AutoPrice"></span>
                            <input type="text" data-bind="value: FuelPrice.OverridePrice, visible: !$root.ViewingHistorical(),
                                id: ('OverridePrice_' + $parent.SiteId + '_' + FuelPrice.FuelTypeId), event:{keyup: changeProp}" class="txtPrice" maxlength="8" />
                            <span style="color: red">
                                <span data-bind="attr :{id: ('OverridePriceHighlight_' + $parent.SiteId + '_' + FuelPrice.FuelTypeId)}"></span>
                            </span>
                            <!-- note: override prices can be extracted using $('#SiteId-FueldTypeId-overridePrice') -->
                            <i data-bind="attr: {
                                    class: (!UpDownValue() || UpDownValue() == 0 || UpDownValue() == '-') ? 'fa fa-arrow-circle-o-right'
                                            : (UpDownValue() <= 0.1) ? 'fa fa-arrow-circle-o-down': 'fa fa-arrow-circle-o-up',
                                    style: (!UpDownValue() || UpDownValue() == 0 || UpDownValue() == '-') ? 'color: grey'
                                            : (UpDownValue() <= 0.1) ? 'color: red': 'color: green',
                                            }"></i>
                            &nbsp;<span data-bind="text: (!UpDownValue() || UpDownValue() == 0 || UpDownValue() == '-') ? '-' :
                                                           (UpDownValue()/10)"></span>
                        </td>
                        <!-- /ko -->
                        <!-- ko if: !siteSupportsFuel -->
                        <td colspan="2">n/a</td>
                        <!-- /ko -->
                        <!-- /ko -->
                    </tr>
                    <tr data-bind="attr:{id: ('AjaxCollapseCompetitorsforsite' + SiteId)}" class="panel-collapse collapse" role="tabpanel">
                        <td colspan="13" xalign="right" style="background-color: grey">
                            <table class="competitorTable table-striped table-hover full-width">
                                <thead>
                                    <tr>
                                        <th><span>Brand</span></th>
                                        <th><span>Marker</span></th>
                                        <th><span>Drive-Time</span></th>
                                        <th><span>Cat No.</span></th>

                                        <th colspan="2" class="text-center" style="border-left: 1px solid #ccc">
                                            <h4>
                                                <span class="label label-success">
                                                    &nbsp;Unleaded&nbsp;
                                                </span>
                                            </h4>
                                        </th>
                                        <th colspan="2" class="text-center" style="border-left: 1px solid #ccc">
                                            <h4>
                                                <span class="label label-black">&nbsp;Diesel&nbsp;</span>
                                            </h4>
                                        </th>
                                        <th colspan="2" class="text-center" style="border-left: 1px solid #ccc">
                                            <h4>
                                                <span class="label label-success-inverted">&nbsp;Super Unleaded&nbsp;</span>
                                            </h4>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th colspan="4"></th>
                                        <th class="tblHighlight"><span>Yesterday</span></th>
                                        <th class="tblHighlight"><span>Today</span></th>
                                        <th><span>Yesterday</span></th>
                                        <th><span>Today</span></th>
                                        <th class="tblHighlight"><span>Yesterday</span></th>
                                        <th class="tblHighlight"><span>Today</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- ko if: loadingCompetitors() -->
                                    <tr>
                                        <td colspan="10" class="noSiteData">Loading... Please wait</td>
                                    </tr>
                                    <!-- /ko -->
                                    <!-- ko if: !loadingCompetitors() -->
                                    <!-- ko if: !hasCompetitors() -->
                                    <tr>
                                        <td colspan="10" class="noSiteData">Sorry, no competitors available</td>
                                    </tr>
                                    <!-- /ko -->
                                    <!-- ko if: hasCompetitors() -->
                                    <!-- ko foreach: competitors -->
                                    <tr>
                                        <td><span data-bind="text: Brand"></span></td>
                                        <td><span data-bind="text: StoreName"></span></td>
                                        <td><span data-bind="text: DriveTime"></span></td>
                                        <td><span data-bind="text: CatNo"></span></td>

                                        <!-- ko foreach: FuelPricesToDisplay -->
                                        <!-- ko if: siteSupportsFuel -->
                                        <td style="border-left: 1px solid #ccc"><span data-bind="text: FuelPrice.YestPrice"></span></td>
                                        <td style="border-left: 1px solid #ccc;" class="tblHighlight text-nowrap text-right">
                                            <span data-bind="text: FuelPrice.TodayPrice"></span>


                                            <i data-bind="attr: {
                                    class: (FuelPrice.Difference == 0 || FuelPrice.Difference == '-') ? 'fa fa-arrow-circle-o-right'
                                            : (FuelPrice.Difference <= 0.1) ? 'fa fa-arrow-circle-o-down': 'fa fa-arrow-circle-o-up',
                                    style: (FuelPrice.Difference == 0 || FuelPrice.Difference == '-') ? 'color: grey'
                                            : (FuelPrice.Difference <= 0.1) ? 'color: red': 'color: green',
                                            }"></i>
                                            &nbsp;<span data-bind="text: (FuelPrice.Difference == 0 || FuelPrice.Difference == '-') ? '-' :
                                                           (FuelPrice.Difference/10)"></span>


                                        </td>
                                        <!-- /ko -->
                                        <!-- ko if: !siteSupportsFuel -->
                                        <td style="border-left: 1px solid #ccc" colspan="2">n/a</td>
                                        <!-- /ko -->
                                        <!-- /ko -->
                                    </tr>
                                    <!-- /ko -->
                                    <!-- /ko -->
                                    <!-- /ko -->
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    <!-- /ko -->
                </tbody>
                <tbody data-bind="visible: $root.dataAvailable() == false" style="display: none">
                    <tr>
                        <td colspan="13" class="noSiteData">No results found</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </form>
</div>

<br />

<script type="text/javascript">
    require(["SitePricing"], function (prices) {
        prices.go();

        $('.datepicker')
            .datepicker({
                language: "en-GB",
                format: 'dd/mm/yyyy',
                orientation: 'auto top',
                autoclose: true,
                todayHighlight: true
            });
    });
     
    
   
</script>
