@using JsPlc.Ssc.PetrolPricing.Models
@model JsPlc.Ssc.PetrolPricing.Models.SiteViewModel

@{
    ViewBag.Title = "Site Prices";
}

<link href="~/Content/prices.css" rel="stylesheet" />

 @using (Html.BeginForm())
{
<h1><i class="fa fa-gbp"></i> Market comparison and planner</h1>
    <hr style="width:1280px;" />
<!-- knockout binds here -->
    <div id="petrolpricingpage" onclick="IsSitePriceFormClicked=1;" style="width: 1280px;">
        <!-- competitor notes popup -->
        <div class="modal fade" id="competitorNotePopup" tabindex="-1" role="dialog" aria-labelledby="competitorNotePopupLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="competitorNotePopupLabel"><i class="fa fa-pencil"></i> Competitor Note for <span id="competitorNotesTitle">-</span></h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-lg-12">
                                <label for="competitorNote">Site Note:</label>
                                <textarea id="competitorNote" rows="5" title="Please enter a Site Note"></textarea>
                                <span id="competitorNoteWarning" class="field-error-message"><i class="fa fa-warning"></i> Please enter some text for the Site Note</span>
                            </div>
                        </div>

                        <div id="competitorPriceNoteDeletePrompt" class="prompt prompt-inline prompt-hidden">
                            <div class="prompt-header">
                                <h4 class="text-center">Do you wish to delete this Site Node?</h4>
                            </div>
                            <div class="prompt-buttons text-center">
                                <button type="button" class="btn btn-danger btn-sm" data-click-action="click-yes, hide-prompt, dismiss-parent-modal"><i class="fa fa-check"></i> Yes</button>
                                <button type="button" class="btn btn-default btn-sm" data-click-action="click-no, hide-prompt"><i class="fa fa-remove "></i> No</button>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger pull-left" id="competitorNodeDeleteButton"><i class="fa fa-times"></i> Delete
                        </button>
                        <button type="button" class="btn btn-default" data-dismiss="modal" id="competitorNodeCancelButton"><i class="fa fa-reply"></i> Cancel</button>
                        <button type="button" class="btn btn-primary" id="competitorNoteSaveButton"><i class="fa fa-check"></i> Save</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- end competitor notes popup within knockout -->

        <!-- Competitor Prices Popup -->
        <div class="modal fade" id="competitorPricesPopup" tabindex="-1" role="dialog" aria-labelledby="competitorPricesPopupLabel">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="competitorPricesPopupLabel"><i class="fa fa-credit-card"></i> <span id="competitorPricePopupStoreName"></span> - Competitor Prices</h4>
                </div>
                <div class="modal-body">

                    <table id="competitorPricesPopupSiteInfo">
                        <thead>
                            <tr>
                                <th>Store No.</th>
                                <th class="leftDivider">Store Name</th>
                                <th class="leftDivider">Store Town</th>
                                <th class="leftDivider">Cat No.</th>
                                <th class="leftDivider">PFS No.</th>
                            </tr>
                            <tr>
                                <th class="text-center"><big class="storeNumber">--</big></th>
                                <th class="text-center leftDivider"><big class="storeName">--</big></th>
                                <th class="text-center leftDivider"><big class="storeTown">--</big></th>
                                <th class="text-center leftDivider"><big class="catNo">--</big></th>
                                <th class="text-center leftDivider"><big class="pfsNo">--</big></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>

                    <!-- start loader -->
                    <div id="competitorPricePopupLoading" class="alert alert-warning busy-loader">
                        <div class="col-md-1 text-center">
                            <i class="fa fa-clock-o fa-2x spinner"></i>
                        </div>
                        <div class="col-md-10 text-center">
                            <strong>Loading Competitor Prices. Please wait...</strong>
                        </div>
                    </div>
                    <!-- end loader-->

                    <!-- start competitor header -->
                    <table id="competitorPricePopupHeader"></table>
                    <!-- end competitor header -->

                    <!-- start competitor table -->
                    <div id="competitorPricePopupPrices"></div>
                    <!-- end competitor table -->
                </div>
                <div class="modal-footer">
                    <div class="footer-actions">
                        <div class="btn-group" data-toggle="buttons-radio">
                            <button id="competitorPricesShowAllNotesButton" class="btn btn-sm btn-default" href="#" title="Show all notes"><i class="fa fa-pencil-square-o"></i> Show notes</button>
                            <button id="competitorPricesHideAllNotesButton" class="btn btn-sm btn-default" title="Hide all notes"><i class="fa fa-pencil-square-o"></i> Hide notes</button>
                        </div>
                    </div>

                    <button type="button" id="competitorPricePopupCloseButton" class="btn btn-primary" data-dismiss="modal"><i class="fa fa-close"></i> Close</button>
                </div>
            </div>
        </div>
        <!-- END Competitor Prices Popup -->

        <!-- Email ALL popup within knockout -->
        <div class="modal fade" id="emailAllSites" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             data-bind="with: emailAllPopupSiteItemModel, visible: showEmailAllPopup">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Send Email to ALL Sites</h4>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to email <strong>ALL</strong> Sites their daily price update?</p>
                        <h5 style="color: red" data-bind="visible: pageHasUnsavedChanges">
                            The prices shown on screen are still UNSAVED.
                            The emails will NOT be sent with these unsaved prices.
                            If you wish to send these prices, please close this popup and click "Save Prices" first.
                        </h5>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal" data-bind="click: emailAllCloseClick">Cancel</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: emailAllClick">Email All Sites</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- END Email ALL popup within knockout -->
        <!-- Email popup within knockout -->
        <div class="modal fade" id="emailSite" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             data-bind="with: emailPopupSiteItemModel, visible: showEmailPopup">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Send Email</h4>
                        <h5 style="color: red" data-bind="visible: pageHasUnsavedChanges">The prices shown are UNSAVED. The email will NOT be sent with these unsaved prices. If you wish to send these prices, please close this popup and click "Save Prices" first.</h5>
                    </div>
                    <div class="modal-body smaller">
                        <h2 style="visibility: hidden; display: none">
                            kSiteName:<span data-bind="text: kSiteName"></span>
                            kStartDateMonthYear:<span data-bind="text: kStartDateMonthYear"></span>
                            kUnleadedPrice:<span data-bind="text: kUnleadedPrice"></span>
                            kDieselPrice:<span data-bind="text: kDieselPrice"></span>
                            showEmailSiteButton:<span data-bind="text: showEmailSiteButton"></span>
                            <input type="button" data-bind="click: emailSendClick" value="Test send click" />
                        </h2> <!-- debug view -->
                        <h1>FAO Store/duty manager - URGENT FUEL PRICE CHANGE</h1>
                        <p>Queries to the Trading Hotline using Option 1 Trading, Option 2 Grocery and Option 8 Petrol and Kiosk </p>
                        <h2><span id="kSiteName" data-bind="text: kSiteName"></span></h2>
                        <p>
                            <strong>
                                Petrol price changes, effective end of trade
                                <span id="kStartDateMonthYear" data-bind="text: kStartDateMonthYear"></span>
                            </strong>
                        </p>
                        <table class="font125pc">
                            <tr><td><strong>Product</strong></td><td><strong>New Price</strong></td></tr>
                            <tr><td>Unleaded&nbsp;</td><td>&nbsp;<span id="kUnleadedPrice" data-bind="text: kUnleadedPrice"></span></td></tr>
                            <tr><td>Super (if applicable)&nbsp;</td><td>&nbsp;<span id="kSuperPrice" data-bind="text: kSuperPrice"></span></td></tr>
                            <tr><td>Diesel&nbsp;</td><td>&nbsp;<span id="kDieselPrice" data-bind="text: kDieselPrice"></span></td></tr>
                        </table>
                        <br />
                        <ul>
                            <li>All fuel price changes must be actioned at the end of trade only</li>
                            <li>Colleague actioning the price change must ensure the changes have applied on the pumps, enter the time of the change and then sign as confirmation before filing this message at the PFS</li>
                            <li>Ensure you enter the new prices correctly into REPOS e.g. If the price is 129.90ppl, then enter 129.90 in the new price field (make sure there are no fuel sales outstanding on the REPOS system or pumps before making the price change, <strong>ALL</strong> working pumps <strong>MUST</strong> be left <strong>ON</strong> and nozzle placed in the pump holders)</li>
                            <li>You are reminded that only fuel price changes sent to you by email should be actioned. Please ignore REPOS price change reports.</li>
                        </ul>
                        <h3>24 hour sites</h3>
                        <ul>
                            <li>Action the price change in conjunction with the REPOS EOD routine between midnight and 2am. Colleague actioning the price change must ensure that the changes have applied on the pumps, enter the time of the change and then sign as confirmation before filing this message at the PFS.</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <h5 style="color: red" data-bind="visible: pageHasUnsavedChanges">The prices shown are UNSAVED. The email will NOT be sent with these unsaved prices. If you wish to send these prices, please close this popup and click "Save Prices" first.</h5>
                        <button type="button" class="btn btn-default" data-dismiss="modal" data-bind="click: hideEmailPopup">Cancel</button>
                        <input type="button" class="btn btn-primary" value="Email Site"
                               id="EmailSiteButton" onclick="" data-dismiss="modal" data-bind="visible: showEmailSiteButton, click: emailSendClick" />
                    </div>
                </div>
            </div>
        </div>
        <!-- End Email popup within knockout -->
        <!-- Submit disabled, all work done thru ajax calls -->
        <form id="myform" method="post" data-bind="submit: savePetrolPricingForm" xclass="input-group-sm" action="sites/PostPrices" onsubmit="return false;" onclick="IsSitePriceFormClicked=1;" style="width: 1280px;">
            <div class="row" onclick="IsSitePriceFormClicked=1;" style="width:1280px;">
                <!-- Date Picker -->
                <div class="col-md-1">
                    <label for="viewingDate">Date:</label>
                    <input type="text" id="viewingDate" class="datepicker form-control" onmousedown="IsSitePriceFormClicked=1;" onclick="IsSitePriceFormClicked=1;"
                           style="width: 85px" name="viewingDate" maxlength="12"
                           data-bind="value: $root.InitDate" />
                </div>
                <!-- Store No -->
                <div class="col-md-1">
                    <label for="viewingStoreNo">Store No:</label>
                    <input type="text" id="viewingStoreNo" class="form-control" maxlength="9" style="width: 70px;"
                           name="viewingStoreNo" data-bind="numeric, value: $root.StoreNo" />
                </div>
                <!-- Store Name -->
                <div class="col-md-2">
                    <label for="viewingStoreName">Store Name:</label>
                    <input type="text" id="viewingStoreName" class="form-control" maxlength="50"
                           name="viewingStoreName" data-bind="value: $root.StoreName" />
                </div>
                <!-- Store Town -->
                <div class="col-md-2">
                    <label for="viewingStoreTown">Store Town:</label>
                    <input type="text" id="viewingStoreTown" class="form-control" maxlength="50"
                           name="viewingStoreTown" data-bind="value: $root.StoreTown" />
                </div>
                <!-- Catalist No -->
                <div class="col-md-1" style="width: 100px;">
                    <label for="viewingCatNo">Catalist No:</label>
                    <input type="text" id="viewingCatNo" class="form-control" maxlength="9" style="width: 70px;"
                           name="viewingCatNo" data-bind="numeric, value: $root.CatNo" />
                </div>
                <!-- go button -->
                <div class="col-md-1">
                    <button style="margin-top: 24px;margin-left:10px;" type="button" id="btnGO" class="btn btn-success" data-bind="click: loadPageWithParams">Go</button>
                </div>
                <!-- show all button -->
                <div class="col-md-1">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-default" data-bind="click: function() { reloadSearchPage('Sites/Prices?date='+$root.InitDateInUsFormat()) }">Show all</button>
                </div>
                <!-- ExportToExcel button -->
                <div class="col-md-1" style="width: 130px; margin-left: 80px;">
                    <label>&nbsp;</label>
                    <button type="button" style="margin-left:0px " class="btn btn-primary" id="btnExportAll"><i class="fa fa-download"></i> Export ALL</button>
                </div>
                <div class="col-md-1" style="margin-left: -20px;">
                    <label>&nbsp;</label>
                    <button type="button" style="margin-left:0px" class="btn btn-primary" id="btnExportSites"><i class="fa fa-download"></i> Export JS Sites</button>
                </div>
            </div>
            <hr style="width:1280px;" />
            <div class="row">
                <div class="col-md-2">
                    <label>Price changes: </label>
                    <!-- ko if: !$root.priceChangeFilterDown() || !$root.priceChangeFilterNone() || !priceChangeFilterUp() -->
                    <button class="btn btn-danger btn-xs" style="margin-left: 2.5em" data-bind="click: resetPriceChangeFilters"><i class="fa fa-power-off"></i> Reset</button>
                    <!-- /ko -->
                    <br />
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm" data-bind="click: togglePriceChangeFilterDown, css: {'btn-primary': $root.priceChangeFilterDown()}"><i class="fa fa-arrow-down"></i> Down</button>
                        <button type="button" class="btn btn-sm" data-bind="click: togglePriceChangeFilterNone, css: {'btn-primary': $root.priceChangeFilterNone()}"><i class="fa fa-minus"></i> None</button>
                        <button type="button" class="btn btn-sm" data-bind="click: togglePriceChangeFilterUp, css: {'btn-primary': $root.priceChangeFilterUp()}"><i class="fa fa-arrow-up"></i> Up</button>
                    </div>
                </div>

                <div class="col-md-10">
                    <label>Excluded Brands</label><br />
                    @Html.ListBoxFor(model => model.ExcludeBrands, new MultiSelectList(Model.AllBrands), new { @data_placeholder = "Select Brands...", @class = "chosen-select", style = "width: 100%;", id = "lstbxexcludebrands" })
                </div>
            </div>
            <br />

            <div class="row" style="margin-bottom: 4px; padding-bottom: 4px;">
                <div class="col-md-3 col-md-offset-9">
                    <div class="btn-group pull-right" role="group">
                        <button type="button" class="btn btn-sm btn-primary" data-click="setExpandMode" data-mode="expanded" data-states="expanded,collapsed" data-target="#PriceDifferencePanel" data-message="Showing Bar Chart"><i class="fa fa-toggle-down"></i> Show</button>
                        <button type="button" class="btn btn-sm" data-click="setExpandMode" data-mode="collapsed" data-states="expanded,collapsed" data-target="#PriceDifferencePanel" data-message="Hiding Bar Chart"><i class="fa fa-toggle-up"></i> Hide</button>
                    </div>
                </div>
            </div>

            <div id="PriceDifferencePanel" class="row font125pc">
                <div class="col-md-12" data-bind="with: dataModel, visible: !$root.dataLoading()" style="display: none;">
                    <div id="PriceDifferenceBarChart" data-bind="css: ('col-md-10 ' + $root.priceDiffBarChartFiltersCss() )"></div>
                </div>
            </div>

            <hr style="width:1280px;" />
            <div style="display: none" class="alert alert-danger" data-bind="visible: $root.HasValidationErrors() || $root.HasErrorMessage()">
                <div class="col-md-1 text-center"><i class="fa fa-exclamation-triangle fa-2x"></i></div>
                <div class="col-md-8" style="padding-top: 2px"><strong><span id="msgError"></span></strong></div>
                <div class="clearfix"></div>
            </div>
            <div style="display: none" class="alert alert-warning" data-bind="visible: !$root.hasAnyFieldErrors() && !$root.HasValidationErrors() && $root.HasUnsavedChanges() && !$root.ViewingHistorical() && !$root.hasBadPriceChangeValue()">
                <div class="col-md-1 text-center"><i class="fa fa-question-circle fa-2x"></i></div>
                <div class="col-md-8">
                    <strong>
                        You have unsaved changes. Would you like to save them?
                    </strong>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-success btn-block" data-bind="click: savePetrolPricingForm">
                        Yes
                    </button>
                </div>
                <div class="clearfix"></div>
            </div>
            <div style="display: none" class="alert alert-success" data-bind="visible: $root.HasSuccessMessage()">
                <div class="col-md-1 text-center"><i class="fa fa-exclamation-triangle fa-2x"></i></div>
                <div class="col-md-4" style="padding-top: 2px"><span id="msgSuccess"></span></div>
                <div class="clearfix"></div>
            </div>

            <div style="display: none;" class="alert alert-danger" data-bind="visible: $root.hasBadPriceChangeValue()">
                <div class="col-md-1 text-center"><i class="fa fa-exclamation-triangle fa-2x"></i></div>
                <div class="col-md-10">
                    <strong>Please enter a valid value for the price change for <span id="msgFuelTypeError"></span>.</strong>
                </div>
                <div class="col-md-1 pull-right">
                    <span class="clickable btn btn-default" data-bind="click:closeWarningPanel">
                        <i class="fa fa-close"></i> Close
                    </span>
                </div>
                <div class="clearfix"></div>
            </div>

            <div style="display:none;" class="alert alert-danger" data-bind="visible: $root.hasAnyFieldErrors() && !$root.HasValidationErrors()">
                <div class="col-md-1 text-center"><i class="fa fa-exclamation-triangle fa-2x"></i></div>
                <div class="col-md-10">
                    <strong>There are <span data-bind="text: fieldErrorCount()"></span> field errors. Please correct and retry.</strong>
                </div>
                <div class="col-md-1">
                    <button data-bind="click: $root.gotoFirstInvalidOverrideField" type="button" class="btn btn-danger" title="Go to first error"><i class="fa fa-chevron-right"></i> First</button>
                </div>

                <div class="clearfix"></div>
            </div>

            <div style="display:block;" class="alert alert-warning busy-loader" data-bind="visible: $root.busyLoadingData()">
                <div class="col-md-1 text-center"><i class="fa fa-clock-o fa-2x spinner"></i></div>
                <div class="col-md-10 text-center">
                    <strong>Loading Sales Pricing information. Please wait...</strong>
                </div>
                <div class="clearfix"></div>
            </div>

            <div class="table-responsive" onclick="IsSitePriceFormClicked=1;" style="width: 1280px;">


                <div class="row" data-bind="visible: !$root.ViewingHistorical()">
                    <!-- Price Change Type -->
                    <div class="col-md-2">
                        <strong>Price change type:</strong>
                    </div>
                    <div class="col-md-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-primary" data-bind="css: {'btn-primary': $root.changeType() == $root.changeTypeValuePlusMinus}, click: setOverrideModePlusMinus">(+/-n)</button>
                            <button type="button" class="btn btn-sm btn-default" data-bind="css: {'btn-primary' : $root.changeType() == $root.changeTypeValueOverrideAll} ,click: setOverrideModeOverrideAll">Override all</button>
                        </div>
                    </div>
                    <div class="col-md-2" style="width: 18em;">
                        <div class="input-group">
                            <span class="input-group-addon" data-bind="text: changeType"></span>
                            <input type="text" class="form-control input-override" maxlength="8" data-bind="value: $root.unleadedOffset" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-primary btn-go" data-bind="click: changePricePerLitreUnleaded">Go</button>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-2" style="width: 18em;">
                        <div class="input-group">
                            <span class="input-group-addon" data-bind="text: changeType"></span>
                            <input type="text" class="form-control input-override" maxlength="8" data-bind="value: $root.dieselOffset" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-primary btn-go" data-bind="click: changePricePerLitreDiesel">Go</button>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-2" style="width: 18em;">
                        <div class="input-group">
                            <span class="input-group-addon" data-bind="text: changeType"></span>
                            <input type="text" class="form-control input-override" maxlength="8" data-bind="value: $root.superOffset" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-primary btn-go" data-bind="click: changePricePerLitreSuper">Go</button>
                            </span>
                        </div>
                    </div>
                </div>
                <br />
                <!-- highlighers -->
                <div class="row" style="margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid #ccc;">
                    <div class="col-md-2">
                        <strong>Price Highlighting:</strong>
                    </div>

                    <div class="col-md-4">
                        <button type="button" class="btn btn-sm" data-bind="click: toggleHighlightTrialPrices, css: {'btn-primary': $root.highlightTrialPrices()}"><i class="fa fa-flask "></i> Trial Prices</button>
                        <button type="button" class="btn btn-sm" data-bind="click: toggleHighlightMatchCompetitors, css: {'btn-primary': $root.highlightMatchCompetitors()}"><i class="fa fa-clone"></i> Match Competitors</button>
                        <button type="button" class="btn btn-sm btn-danger" data-bind="visible: ($root.highlightTrialPrices() || $root.highlightMatchCompetitors()), click: resetPriceHighlighting"><i class="fa fa-power-off "></i> Reset</button>
                    </div>

                    <div class="col-md-3">
                    </div>

                    <div class="col-md-3 col">
                        <div class="btn-group pull-right" role="group">
                            <button type="button" class="btn btn-sm btn-primary" data-click="setExpandMode" data-mode="collapsed" data-states="expanded,collapsed" data-target="#PricingPanelScroller" data-message="Price grid collapsed"><i class="fa fa-toggle-up"></i> Collapse</button>
                            <button type="button" class="btn btn-sm" data-click="setExpandMode" data-mode="expanded" data-states="expanded,collapsed" data-target="#PricingPanelScroller" data-message="Price grid expanded"><i class="fa fa-toggle-down"></i> Expand</button>
                        </div>
                    </div>
                </div>

                <!-- start grid header -->
                <table class="pricing-grid">
                    <thead>
                        <!-- first row -->
                        <tr>
                            <th class="col-header-competitor">#</th>
                            <th class="col-header-store-no">Store No.</th>
                            <th class="col-header-email">@@</th>
                            <th class="col-header-store-name">Store Name</th>
                            <th class="col-header-store-town">Store Town</th>
                            <th class="col-header-cat-no">Cat No.</th>
                            <th class="col-header-pfs-no">PFS No.</th>
                            <th class="col-header-unleaded" colspan="2">
                                <h4>
                                    <span class="label label-success">&nbsp;Unleaded&nbsp;</span>
                                </h4>
                            </th>
                            <th class="col-header-diesel" colspan="2">
                                <h4>
                                    <span class="label label-black">&nbsp;Diesel&nbsp;</span>
                                </h4>
                            </th>
                            <th class="col-header-super-unleaded" colspan="2">
                                <h4>
                                    <span class="label label-success-inverted">&nbsp;Super Unleaded&nbsp;</span>
                                </h4>
                            </th>
                        </tr>

                        <!-- second row -->
                        <tr>
                            <th colspan="3">
                                <!-- EMAIL all Button, only loads popup -->
                                <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#emailAllSites"
                                        data-bind="visible: !$root.ViewingHistorical() && $root.dataAvailable() == true">
                                    Email all &nbsp;<i class="fa fa-envelope-o"></i>
                                </button>
                            </th>
                            <th colspan="4"></th>
                            <th class="col-header-yesterday-unleaded">
                                <span id="today1">-</span>
                            </th>
                            <th class="col-header-tomorrow-unleaded">
                                <span id="tomorrow1">-</span>
                            </th>
                            <th class="col-header-yesterday-diesel">
                                <span id="today2">-</span>
                            </th>
                            <th class="col-header-tomorrow-diesel">
                                <span id="tomorrow2">-</span>
                            </th>
                            <th class="col-header-yesterday-super-unleaded">
                                <span id="today3">-</span>
                            </th>
                            <th class="col-header-tomorrow-super-unleaded">
                                <span id="tomorrow3">-</span>
                            </th>
                        </tr>
                    </thead>
                </table>
                <!-- end of grid header -->

                <hr style="padding:0px;margin:0px" />

                <div class="row" id="SorryNoResultsPanel" data-bind="visible: $root.shouldShowSorryResults" style="display: none; padding: 3em 2em;">
                    <div class="col-md-13 text-center font150pc">
                        Sorry, no data was found. Try a different search criteria or
                        <!-- ko if: !$root.priceChangeFilterUp() || !$root.priceChangeFilterDown() || !$root.priceChangeFilterNone() -->
                        <button type="button" class="btn btn-danger btn-sm" data-bind="click: resetPriceChangeFilters"><i class="fa fa-power-off"></i> Reset</button> the Price Change filters.
                        <!-- /ko -->
                    </div>
                </div>

                <!-- ko if: $root.busyLoadingData() -->
                <div class="row" style="padding: 3em 2em;">
                    <div class="col-md-13 text-center font150pc">
                        Loading Sales Pricing information. Please wait...
                    </div>
                </div>
                <!-- /ko -->

                <div id="PricingPanelScroller" class="actualdata collapsed" style="padding:0px;margin:0px; display: none;" data-bind="with: dataModel, visible: !busyLoadingData()">
                    <table class="pricing-grid">
                        <tbody>
                            <!-- JS Store DataRows -->
                            <!-- ko foreach: sites -->
                            <tr class="row site-row" role="tab" data-bind="id:('Heading' + SiteId), attr: {id: 'SiteHeading' + SiteId, 'data-price-change-signs': (priceChangeSigns())}, css: (siteRowCss())">
                                <td class="col-competitor">
                                    <a role="button" data-toggle="modal" data-bind="attr:{id: SiteId}, click: getCompetitorPopupDataClick"
                                       data-target="#competitorPricesPopup" title="View competitor's prices">
                                        <i class="fa fa-credit-card"></i>
                                    </a>

                                    @*<a role="button" data-toggle="collapse" data-parent="#accordion" onclick="IsSitePriceFormClicked=1;"
                                    data-bind="attr:{href:('#CollapseCompetitorsforsite' + SiteId)}, click: getCompetitorDataClick"><i class="fa fa-minus-square-o" data-bind="css: showingComps() ? 'fa fa-minus-square-o' : 'fa fa-plus-square-o'"></i></a>*@
                                </td>
                                <td class="col-store-no text-center" data-bind="text: StoreNo"></td>
                                <!-- Email envelope... -->
                                <td class="col-email">
                                    <span>
                                        <!-- ko if: $root.ViewingHistorical()-->
                                        <i class="fa fa-clock-o" title="Viewing historical data" style="color: grey;"></i>
                                        <!-- /ko -->
                                        <!-- ko if: !$root.ViewingHistorical() -->
                                        <i class="fa fa-warning text-danger" data-bind="visible: !HasEmails" title="Site has no emails."></i>
                                        <a tabindex="-1" href="#" data-toggle="modal" data-target="#emailSite" data-bind="click: bindEmailTemplate">
                                            <i class="fa fa-envelope-o" data-bind="visible: HasEmails && canSendEmail()"></i>
                                            <!-- ko if: hasEmailSendLogEntry() -->
                                            <!-- ko with: EmailSendLogEntry -->
                                            <i class="fa fa-check" data-bind="visible: IsSuccess, attr: {title:'Email sent..'}" style="color: green"></i>
                                            <i class="fa fa-warning" data-bind="visible: IsWarning, attr: {title:WarningMessage}" style="color: orange"></i>
                                            <i class="fa fa-ban" data-bind="visible: IsError, attr: {title:ErrorMessage}" style="color: red"></i>
                                            <!-- /ko -->
                                            <!-- /ko -->
                                        </a>
                                        <!-- /ko -->
                                    </span>
                                </td>
                                <td class="col-store-name"><a tabindex="-1" title="Edit this site" data-bind="attr: {'href': ('@Url.Action("Edit", "Sites")/' + SiteId)}"><span data-bind="text: StoreName"></span> <i class="fa fa-edit"></i></a></td>
                                <td class="col-store-town"><span data-bind="text: Town"></span></td>
                                <td class="col-cat-no text-center"><span data-bind="text: CatNo"></span></td>
                                <td class="col-pfs-no text-center"><span data-bind="text: PfsNo"></span></td>

                                <!-- ko foreach: FuelPricesToDisplay -->
                                <!-- ko if: siteSupportsFuel -->
                                <td data-bind="css: ('col-yesterday' + (isEditingFuel() ? ' col-editing' : '') + (hasValidValue() ? ' col-valid' : ' col-invalid'))">
                                    <span data-bind="css: ('fuel-price-change-' + UpDownSignCss()), html: FuelPrice.ForecourtTodayPriceHtml"></span>
                                </td>
                                <td data-bind="css: ('col-today' + (isEditingFuel() ? ' col-editing' : '') + (hasValidValue() ? ' col-valid' : ' col-invalid'))">
                                    <div data-bind="css: ('fuel-price-change-' + UpDownSignCss())">
                                        <!-- ko if: FuelPrice.IsTrailPrice -->
                                        <span class="padded-price-right trial-price" data-bind="attr: {title: 'Trial Price: ' + FuelPrice.CompetitorName}, html: FuelPrice.ForecourtAutoPriceHtml()"></span>
                                        <!-- /ko -->
                                        <!-- ko if: !FuelPrice.IsTrailPrice -->
                                        <span class="padded-price-right match-competitor-price" data-bind="attr: {title: 'Match Competitor: ' + FuelPrice.CompetitorName + '; Markup: ' + FuelPrice.Markup}, html: FuelPrice.ForecourtAutoPriceHtml()"></span>
                                        <!-- /ko -->
                                        <input type="text" data-bind="value: FuelPrice.OverridePrice, visible: !$root.ViewingHistorical(),
                                id: ('OverridePrice_' + $parent.SiteId + '_' + FuelPrice.FuelTypeId), event:{keyup: changeProp, blur: blurred, focus: focused}, css: ('txtPrice ' + OverrideInputCss())" maxlength="8" />
                                        <span data-bind="attr :{id: ('OverridePriceHighlight_' + $parent.SiteId + '_' + FuelPrice.FuelTypeId)}"></span>
                                        <!-- note: override prices can be extracted using $('#SiteId-FueldTypeId-overridePrice') -->
                                        <i data-bind="attr: {class: (UpDownIconCss())}"></i>
                                        &nbsp;<span class="price-diff" data-bind="text: (UpDownText())"></span>
                                    </div>
                                </td>
                                <!-- /ko -->
                                <!-- ko if: !siteSupportsFuel -->
                                <td class="dividerLeft">n/a</td>
                                <td class="dividerLeft">n/a</td>
                                <!-- /ko -->
                                <!-- /ko -->
                            </tr>
                            <!-- /ko -->
                        </tbody>
                    </table>

                    <!-- TODO: shift out of here for popup !! -->

                    <div data-bind="with: $root.dataModel, visible: !$root.busyLoadingData()">
                        <!-- ko foreach: sites -->
                        <div data-bind="attr:{id: ('AjaxCollapseCompetitorsforsite' + SiteId)}" onclick="IsSitePriceFormClicked=1;" class="panel-collapse collapse" role="tabpanel" style="background-color: grey">
                            <div class="compitatorData">
                                <table class="competitorTable table-striped table-hover full-width">
                                    <colgroup>
                                        <col width="12%" />
                                        <col width="6%" />
                                        <col width="18%" />
                                        <col width="4%" />
                                        <col width="4%" />

                                        <col width="6%" />
                                        <col width="6%" />
                                        <col width="6%" />
                                        <col width="6%" />
                                        <col width="6%" />
                                        <col width="6%" />
                                        <col width="6%" />
                                        <col width="6%" />
                                        <col width="6%" />
                                    </colgroup>

                                    <thead>
                                        <tr>
                                            <th class="num1"><span>Brand</span></th>
                                            <th class="num2"><span>Notes</span></th>
                                            <th class="num3"><span>Marker</span></th>
                                            <th class="num4"><span>Drive-Time</span></th>
                                            <th class="num5"><span>Cat No.</span></th>

                                            <th colspan="3" class="text-center dividerLeft">
                                                <h4>
                                                    <span class="label label-success">
                                                        &nbsp;Unleaded&nbsp;
                                                    </span>
                                                </h4>
                                            </th>
                                            <th colspan="3" class="text-center dividerLeft">
                                                <h4>
                                                    <span class="label label-black">&nbsp;Diesel&nbsp;</span>
                                                </h4>
                                            </th>
                                            <th colspan="3" class="text-center dividerLeft">
                                                <h4>
                                                    <span class="label label-success-inverted">&nbsp;Super Unleaded&nbsp;</span>
                                                </h4>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th colspan="5"></th>
                                            <th class="num6 tblHighlight"><span class="compyday">Yesterday</span></th>
                                            <th class="num7 tblHighlight"><span class="comptoday">Today</span></th>
                                            <th class="num8 tblHighlight"><span class="jsdiff">JS_Diff</span></th>
                                            <th class="num9"><span class="compyday">Yesterday</span></th>
                                            <th class="num10"><span class="comptoday">Today</span></th>
                                            <th class="num11"><span class="jsdiff">JS_Diff</span></th>
                                            <th class="num12 tblHighlight"><span class="compyday">Yesterday</span></th>
                                            <th class="num13 tblHighlight"><span class="comptoday">Today</span></th>
                                            <th class="num14 tblHighlight"><span class="jsdiff">JS_Diff</span></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- ko if: loadingCompetitors() -->
                                        <tr>
                                            <td colspan="14" class="noSiteData text-center"><span class="please-wait"><i class="fa fa-clock-o spinner"></i> Loading... Please wait</span></td>
                                        </tr>
                                        <!-- /ko -->
                                        <!-- ko if: !loadingCompetitors() -->
                                        <!-- ko if: !hasCompetitors() -->
                                        <tr>
                                            <td colspan="14" class="noSiteData text-center"><span class="no-competitors"><i class="fa fa-info-circle"></i> Sorry, no competitors available</span></td>
                                        </tr>
                                        <!-- /ko -->
                                        <!-- ko if: hasCompetitors() -->
                                        <!-- ko foreach: competitors -->
                                        <tr class="competitor-row hoverable" title="Double click to edit/create Site Note" data-bind="attr:{id:'CompetitorSiteRow_' + SiteId}, style: {background : $parent.FuelPricesToDisplay[0].FuelPrice.CompetitorName == Brand + '/' + StoreName  && $parent.FuelPricesToDisplay[0].FuelPrice.AutoPrice >0 ?  'yellow' : 'lightgray'}">
                                            <td class="num1"><span data-bind="text: Brand"></span></td>
                                            <td class="num2">
                                                <button type="button" class="btn btn-default btn-xs triggerEditSiteNote" data-bind="attr:{id: 'EditSiteNoteButton_' + SiteId}" title="Create or edit note"><i class="fa fa-pencil"></i></button>
                                                <button type="button" class="btn btn-default btn-xs triggerToggleNote" data-bind="attr:{id: 'ToggleSiteNoteButton_' + SiteId}" title="Show Note"><i class="fa fa-sort-up"></i></button>
                                            </td>
                                            <td class="num3"><span data-bind="text: StoreName"></span></td>
                                            <td class="num4"><b><span data-bind="text: DriveTime"></span></b></td>
                                            <td class="num5"><span data-bind="text: CatNo"></span></td>

                                            <!-- ko foreach: FuelPricesToDisplay -->
                                            <!-- ko if: siteSupportsFuel -->
                                            <td style="border-left: 1px solid #ccc"><span data-bind="text: FuelPrice.YestPrice"></span></td>
                                            <td style="border-left: 1px solid #ccc;">
                                                <span data-bind="text: FuelPrice.TodayPrice"></span>


                                                <i data-bind="attr: {
                                                   class (FuelPrice.Difference= =0 || FuelPrice.Difference= ='-' ) ? 'fa fa-arrow-circle-o-right'
                                                   (FuelPrice.Difference <= 0.1) ? 'fa fa-arrow-circle-o-down': 'fa fa-arrow-circle-o-up',
                                style: (FuelPrice.Difference == 0 || FuelPrice.Difference == '-') ? 'color: grey'
                                        : (FuelPrice.Difference <= 0.1) ? 'color: red': 'color: green',
                                        }"></i>
                                                &nbsp;<span data-bind="text: (FuelPrice.Difference == 0 || FuelPrice.Difference == '-') ? '-' :
                                                       (FuelPrice.Difference/10)"></span>


                                            </td>
                                            <td style="border-left: 1px solid #ccc;">

                                                <div data-bind="if: FuelPrice.FuelTypeId==2">
                                                    <div data-bind="if: ($parents[1].FuelPricesToDisplay[0].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)  != 'NaN' ">
                                                        <span data-bind="text: ($parents[1].FuelPricesToDisplay[0].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) "></span>
                                                        <i data-bind="attr: {
                                                           class ( ($parents[1].FuelPricesToDisplay[0].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)= =0 || ($parents[1].FuelPricesToDisplay[0].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)= ='NaN' ) ? ''
                                                           (($parents[1].FuelPricesToDisplay[0].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)  <= 0.1) ? 'fa fa-minus': 'fa fa-plus',
                                style: (($parents[1].FuelPricesToDisplay[0].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)  == 0 || ($parents[1].FuelPricesToDisplay[0].FuelPrice.AutoPrice - FuelPrice.TodayPrice ).toFixed(1) == 'NaN') ? 'color: grey'
                                        :( ($parents[1].FuelPricesToDisplay[0].FuelPrice.AutoPrice - FuelPrice.TodayPrice ).toFixed(1)  <= 0.1) ? 'color: red': 'color: green'
                                        }"></i>
                                                    </div>
                                                    <div data-bind="if: ($parents[1].FuelPricesToDisplay[0].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) == 'NaN' ">
                                                        <span>n/a</span>
                                                    </div>


                                                </div>
                                                <div data-bind="if: FuelPrice.FuelTypeId==6">

                                                    <div data-bind="if: ($parents[1].FuelPricesToDisplay[1].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)  != 'NaN' ">
                                                        <span data-bind="text: ($parents[1].FuelPricesToDisplay[1].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) "></span>
                                                        <i data-bind="attr: {
                                                           class ( ($parents[1].FuelPricesToDisplay[1].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)= =0 || ($parents[1].FuelPricesToDisplay[1].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)= ='NaN' ) ? ''
                                                           (($parents[1].FuelPricesToDisplay[1].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) <= 0.1) ? 'fa fa-minus': 'fa fa-plus',
                                style: (($parents[1].FuelPricesToDisplay[1].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) == 0  || ($parents[1].FuelPricesToDisplay[1].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) == 'NaN' ) ? 'color: grey'
                                        :( ($parents[1].FuelPricesToDisplay[1].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) <= 0.1) ? 'color: red': 'color: green'
                                        }"></i>
                                                    </div>
                                                    <div data-bind="if: ($parents[1].FuelPricesToDisplay[1].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) == 'NaN' ">
                                                        <span>n/a</span>
                                                    </div>

                                                </div>
                                                <div data-bind="if: FuelPrice.FuelTypeId==1">
                                                    <div data-bind="if: ($parents[1].FuelPricesToDisplay[2].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)  != 'NaN' ">
                                                        <span data-bind="text: ($parents[1].FuelPricesToDisplay[2].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) "></span>
                                                        <i data-bind="attr: {
                                                           class ( ($parents[1].FuelPricesToDisplay[2].FuelPrice.AutoPrice -FuelPrice.TodayPrice).toFixed(1)= =0 || ($parents[1].FuelPricesToDisplay[2].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1)= ='NaN' ) ? ''
                                                           (($parents[1].FuelPricesToDisplay[2].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) <= 0.1) ? 'fa fa-minus': 'fa fa-plus',
                                style: (($parents[1].FuelPricesToDisplay[2].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) == 0 || ($parents[1].FuelPricesToDisplay[2].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) == 'NaN') ? 'color: grey'
                                        :( ($parents[1].FuelPricesToDisplay[2].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) <= 0.1) ? 'color: red': 'color: green'
                                        }"></i>
                                                    </div>
                                                    <div data-bind="if: ($parents[1].FuelPricesToDisplay[2].FuelPrice.AutoPrice - FuelPrice.TodayPrice).toFixed(1) == 'NaN' ">
                                                        <span>n/a</span>
                                                    </div>

                                                </div>
                                            </td>
                                            <!-- /ko -->
                                            <!-- ko if: !siteSupportsFuel -->
                                            <td style="border-left: 1px solid #ccc" colspan="3">n/a</td>
                                            <!-- /ko -->
                                            <!-- /ko -->
                                        </tr>
                                        <tr class="note-row" data-bind="attr:{id:'CompetitorNote_' + SiteId}">
                                            <td colspan="14">
                                                <div class="note-panel">
                                                    <p class="note-panel-text" data-bind="formatSiteNote: Notes" title="Click to edit"></p>
                                                </div>
                                            </td>
                                        </tr>
                                        <!-- /ko -->
                                        <!-- /ko -->
                                        <!-- /ko -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- /ko -->

                    </div>


                </div>

                <div class="row" style="margin-top: 4px; padding-top: 4px; border-top: 1px solid #ccc;">
                    <div class="col-md-3 col-md-offset-9">
                        <div class="btn-group pull-right" role="group">
                            <button type="button" class="btn btn-xs btn-primary" data-click="setExpandMode" data-mode="collapsed" data-states="expanded,collapsed" data-target="#PricingPanelScroller" data-message="Price grid collapsed"><i class="fa fa-toggle-up"></i> Collapse</button>
                            <button type="button" class="btn btn-xs" data-click="setExpandMode" data-mode="expanded" data-states="expanded,collapsed" data-target="#PricingPanelScroller" data-message="Price grid expanded"><i class="fa fa-toggle-down"></i> Expand</button>
                        </div>
                    </div>
                </div>

            </div>
        </form>
    </div>
<br />
}

<script src="~/Scripts/App/prices.js"></script>
