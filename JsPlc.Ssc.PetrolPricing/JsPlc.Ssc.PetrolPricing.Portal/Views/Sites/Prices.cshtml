@{
    ViewBag.Title = "Site Prices";
}
<!-- Modal -->
@*<form id="myform" method="post" action="sites/prices">*@
<!-- email popup was here -->
@*</form>*@

@*<form id="myform" method="post" action="emailAllSites">*@
@*</form>*@
<style type="text/css">
    .smaller-normal {
        font-size: smaller;
        font-weight: normal;
    }

    .smaller {
        font-size: smaller;
    }
</style>

<h2>Site Prices</h2>

<!-- knockout binds here -->
<div class="container" id="petrolpricingpage">
    <div id="msgs"></div>

    <!-- Email ALL popup within knockout -->
    <div class="modal fade" id="emailAllSites" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         data-bind="with: emailAllPopupSiteItemModel, visible: showEmailAllPopup">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Send Email to ALL Sites</h4>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to email <strong>ALL</strong> Sites their daily price update?</p>
                    <h5 style="color: red" data-bind="visible: pageHasUnsavedChanges">
                        The prices shown on screen are still UNSAVED.
                        The emails will NOT be sent with these unsaved prices.
                        If you wish to send these prices, please close this popup and click "Save Prices" first.
                    </h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-bind="click: emailAllCloseClick">Cancel</button>
                    <button type="submit" class="btn btn-default" data-dismiss="modal" data-bind="click: emailAllClick">Email All Sites</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END Email ALL popup within knockout -->
    <!-- Email popup within knockout -->
    <div class="modal fade" id="emailSite" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         data-bind="with: emailPopupSiteItemModel, visible: showEmailPopup">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Send Email</h4>
                    <h5 style="color: red" data-bind="visible: pageHasUnsavedChanges">The prices shown are UNSAVED. The email will NOT be sent with these unsaved prices. If you wish to send these prices, please close this popup and click "Save Prices" first.</h5>
                    @*<span xdata-bind="text: emailSendResult"></span>*@
                </div>
                <div class="modal-body smaller">
                    <h2 style="visibility: hidden; display: none">
                        kSiteName:<span data-bind="text: kSiteName"></span>
                        kStartDateMonthYear:<span data-bind="text: kStartDateMonthYear"></span>
                        kUnleadedPrice:<span data-bind="text: kUnleadedPrice"></span>
                        kDieselPrice:<span data-bind="text: kDieselPrice"></span>
                        showEmailSiteButton:<span data-bind="text: showEmailSiteButton"></span>
                        <input type="button" data-bind="click: emailSendClick" value="Test send click" />
                    </h2> <!-- debug view -->
                    <h1>FAO Store/duty manager - URGENT FUEL PRICE CHANGE</h1>
                    <p>Queries to the Trading Hotline using Option 1 Trading, Option 2 Grocery and Option 8 Petrol and Kiosk </p>
                    <h2><span id="kSiteName" data-bind="text: kSiteName"></span></h2>
                    <p>
                        <strong>
                            Petrol price changes, effective end of trade
                            <span id="kStartDateMonthYear" data-bind="text: kStartDateMonthYear"></span>
                        </strong>
                    </p>
                    <table>
                        <tr><td><strong>Product</strong></td><td><strong>New Price</strong></td></tr>
                        <tr><td>Unleaded</td><td><span id="kUnleadedPrice" data-bind="text: kUnleadedPrice"></span></td></tr>
                        <tr><td>Super (if applicable)</td><td><span id="kSuperPrice" data-bind="text: kSuperPrice"></span></td></tr>
                        <tr><td>Diesel</td><td><span id="kDieselPrice" data-bind="text: kDieselPrice"></span></td></tr>
                    </table>
                    <br />
                    <ul>
                        <li>All fuel price changes must be actioned at the end of trade only</li>
                        <li>Colleague actioning the price change must ensure the changes have applied on the pumps, enter the time of the change and then sign as confirmation before filing this message at the PFS</li>
                        <li>Ensure you enter the new prices correctly into REPOS e.g. If the price is 129.90ppl, then enter 129.90 in the new price field (make sure there are no fuel sales outstanding on the REPOS system or pumps before making the price change, <strong>ALL</strong> working pumps <strong>MUST</strong> be left <strong>ON</strong> and nozzle placed in the pump holders)</li>
                        <li>You are reminded that only fuel price changes sent to you by email should be actioned. Please ignore REPOS price change reports.</li>
                    </ul>
                    <h3>24 hour sites</h3>
                    <ul>
                        <li>Action the price change in conjunction with the REPOS EOD routine between midnight and 2am. Colleague actioning the price change must ensure that the changes have applied on the pumps, enter the time of the change and then sign as confirmation before filing this message at the PFS.</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <h5 style="color: red" data-bind="visible: pageHasUnsavedChanges">The prices shown are UNSAVED. The email will NOT be sent with these unsaved prices. If you wish to send these prices, please close this popup and click "Save Prices" first.</h5>
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-bind="click: hideEmailPopup">Cancel</button>
                    <input type="button" class="btn btn-default" value="Email Site"
                           id="EmailSiteButton" onclick="" data-dismiss="modal" data-bind="visible: showEmailSiteButton, click: emailSendClick" />
                </div>
            </div>
        </div>
    </div>
    <!-- End Email popup within knockout -->
    <!-- Submit disabled, all work done thru ajax calls -->
    <form id="myform" method="post" data-bind="submit: savePetrolPricingForm" xclass="input-group-sm" action="sites/PostPrices" onsubmit="return false;">
        <div class="row">
            <div class="col-md-12">
                <div class="col-md-9 left"><span>Market Comparison: Sainsburys's prices and Competitors</span></div>
                <div class="col-md-3 text-right">

                    <!-- EMAIL all Button, only loads popup -->
                    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#emailAllSites"
                            data-bind="visible: !$root.ViewingHistorical()">
                        Email all &nbsp;<i class="fa fa-envelope-o"></i>
                    </button>

                </div>
            </div>
        </div>
        <hr class="hide" data-bind="visible: !$root.HasValidationErrors() && $root.HasUnsavedChanges() && !$root.ViewingHistorical()" />
        <div class="hide row" data-bind="visible: !$root.HasValidationErrors() && $root.HasUnsavedChanges() && !$root.ViewingHistorical()">
            <div class="col-md-12">
                <div class="col-md-12 text-right">
                    <button type="button" class="btn btn-default" id="btnSavePrices"
                            data-bind="click: savePetrolPricingForm">
                        Save Prices
                    </button>
                    <div id="unSavedChangesMsg" style="color: brown; font-size: larger">You have unsaved changes</div>
                </div>
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-md-12">
                <!-- Date Picker -->
                <div class="col-md-1">
                    <label for="viewingDate">Date:</label>
                    <input type="text" id="viewingDate" class="datepicker form-control"
                           style="width: 85px" name="viewingDate"
                           data-bind="value: $root.InitDate" />
                </div>
                <!-- Store Name -->
                <div class="col-md-2">
                    <label for="viewingStoreName">Store name:</label>
                    <input type="text" id="viewingStoreName" class="form-control"
                           name="viewingStoreName" data-bind="value: $root.StoreName" />
                </div>
                <!-- Store Town -->
                <div class="col-md-2">
                    <label for="viewingStoreTown">Store town:</label>
                    <input type="text" id="viewingStoreTown" class="form-control"
                           name="viewingStoreTown" data-bind="value: $root.StoreTown" />
                </div>
                <!-- Store No -->
                <div class="col-md-2">
                    <label for="viewingStoreNo">Store #:</label>
                    <input type="text" id="viewingStoreNo" class="form-control"
                           name="viewingStoreNo" data-bind="numeric, value: $root.StoreNo" />
                </div>
                <!-- Catalist No -->
                <div class="col-md-1">
                    <label for="viewingCatNo">Catalist #:</label>
                    <input type="text" id="viewingCatNo" class="form-control"
                           name="viewingCatNo" data-bind="numeric, value: $root.CatNo" />
                </div>

                <div class="col-md-1 left">
                    <button style="margin-top: 24px" type="button" class="btn btn-default" data-bind="click: loadPageWithParams">Go</button>
                </div>
            </div>
        </div>
        <hr />
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="accordion">
                <!-- HEADINGS -->
                <thead>
                    <tr>
                        <th colspan="7">
                            <!-- Price Change Type -->
                            <div class="col-md-4" style="margin-left: -10px"><b>Price change type:</b></div>
                            <div class="col-md-4">
                                <span><input type="radio" value="(+/-n)" data-bind="click: switchChangeType, checked: changeType" /> (+/-n)</span>
                                <span><input type="radio" value="Override all" data-bind="click: switchChangeType, checked: changeType" /> Override all</span>
                            </div>

                        </th>
                        <th colspan="2">
                            <span class="smaller-normal" data-bind="visible: !$root.ViewingHistorical()">
                                <span style="display: inline-block; width: 55px" data-bind="text: changeType"></span>
                                <input type="text" style="width: 30px; height: 20px;" data-bind="value: $root.unleadedOffset" />
                                <input type="button" value="Go" data-bind="click: changePricePerLitreUnleaded" />
                            </span>
                        </th>
                        <th colspan="2">
                            <span class="smaller-normal" data-bind="visible: !$root.ViewingHistorical()">
                                <span style="display: inline-block; width: 55px" data-bind="text: changeType"></span>
                                <input type="text" style="width: 30px; height: 20px;" data-bind="value: $root.dieselOffset" />
                                <input type="button" value="Go" data-bind="click: changePricePerLitreDiesel" />
                            </span>
                        </th>
                        <th colspan="2">
                            <span class="smaller-normal" data-bind="visible: !$root.ViewingHistorical()">
                                <span style="display: inline-block; width: 55px" data-bind="text: changeType"></span>
                                <input type="text" style="width: 30px; height: 20px;" data-bind="value: $root.superOffset" />
                                <input type="button" value="Go" data-bind="click: changePricePerLitreSuper" />
                            </span>
                        </th>
                    </tr>
                    <!-- 11 column layout -->
                    <tr rowspan="2" style="background-color: silver">
                        <th colspan="1"><span>#</span></th>
                        <th><span>Store No.</span></th>
                        <th><span></span></th>
                        <th width="200"><span>Store Name</span></th>
                        <th width="100"><span>Store Town</span></th>
                        <th><span>Cat No.</span></th>
                        <th><span>PFS No.</span></th>

                        <th colspan="2">
                            <span class="fuelHeaderGroup">
                                &nbsp;Unleaded&nbsp;
                            </span>

                        </th>
                        <th colspan="2">
                            <span class="fuelHeaderGroup">&nbsp;Diesel&nbsp;</span>
                        </th>
                        <th colspan="2">
                            <span class="fuelHeaderGroup">&nbsp;Super Unleaded&nbsp;</span>
                        </th>
                    </tr>
                    <tr>
                        <!-- 12 column layout -->
                        <th colspan="6"></th>

                        <th><span>Today</span></th>
                        <th><span>Tomorrow</span></th>
                        <th><span>Today</span></th>
                        <th><span>Tomorrow</span></th>
                        <th><span>Today</span></th>
                        <th><span>Tomorrow</span></th>
                    </tr>
                </thead>
                <tbody data-bind="with: dataModel">
                    <!-- JS Store DataRows -->
                    <!-- ko foreach: sites -->
                    <tr class="panel-heading" role="tab" data-bind="id:('Heading' + SiteId)">
                        <td>
                            <a role="button" data-toggle="collapse" data-parent="#accordion"
                               data-bind="attr:{href:('#CollapseCompetitorsforsite' + SiteId)}, click: getCompetitorDataClick"><i class="fa fa-plus-square-o"></i></a>
                        </td>
                        <td><span data-bind="text: StoreNo"></span></td>
                        <!-- Email envelope... -->
                        <td>
                            <span>
                                <a href="#" data-toggle="modal" data-target="#emailSite" data-bind="click: bindEmailTemplate">
                                    <i class="fa fa-envelope-o"></i>
                                    <!-- ko if: hasEmailSendLogEntry() -->
                                    <!-- ko with: EmailSendLogEntry -->
                                    <i class="fa fa-check" data-bind="visible: IsSuccess, attr: {title:'Email sent..'}" style="color: green"></i>
                                    <i class="fa fa-warning" data-bind="visible: IsWarning, attr: {title:WarningMessage}" style="color: orange"></i>
                                    <i class="fa fa-ban" data-bind="visible: IsError, attr: {title:ErrorMessage}" style="color: red"></i>
                                    <!-- /ko -->
                                    <!-- /ko -->
                                </a>
                            </span>
                        </td>
                        <td><span data-bind="text: StoreName"></span></td>
                        <td><span data-bind="text: Town"></span></td>
                        <td><span data-bind="text: CatNo"></span></td>
                        <td><span data-bind="text: PfsNo"></span></td>

                        <!-- ko foreach: FuelPricesToDisplay -->
                        <!-- ko if: siteSupportsFuel -->
                        <td>
                            <span data-bind="text: FuelPrice.TodayPrice"></span>
                        </td>
                        <td>
                            &nbsp;<span data-bind="attr:{title:(FuelPrice.IsTrailPrice ? 'Trail price: ' + FuelPrice.CompetitorName : 'Competitor name: ' + FuelPrice.CompetitorName + '; Markup: ' + FuelPrice.Markup)}, text: FuelPrice.AutoPrice"></span>
                            <input type="text" data-bind="value: FuelPrice.OverridePrice, visible: !$root.ViewingHistorical(),
                                id: ('OverridePrice_' + $parent.SiteId + '_' + FuelPrice.FuelTypeId), event:{keyup: changeProp}" class="txtPrice" />
                            <span style="color: red">
                                <span data-bind="attr :{id: ('OverridePriceHighlight_' + $parent.SiteId + '_' + FuelPrice.FuelTypeId)}"></span>
                            </span>
                            <!-- note: override prices can be extracted using $('#SiteId-FueldTypeId-overridePrice') -->
                            <i data-bind="attr: {
                                    class: (!UpDownValue() || UpDownValue() == 0 || UpDownValue() == '-') ? 'fa fa-arrow-circle-o-right'
                                            : (UpDownValue() <= 0.1) ? 'fa fa-arrow-circle-o-down': 'fa fa-arrow-circle-o-up',
                                    style: (!UpDownValue() || UpDownValue() == 0 || UpDownValue() == '-') ? 'color: grey'
                                            : (UpDownValue() <= 0.1) ? 'color: red': 'color: green',
                                            }"></i>
                            &nbsp;<span data-bind="text: (!UpDownValue() || UpDownValue() == 0 || UpDownValue() == '-') ? '-' :
                                                           (UpDownValue()/10)"></span>
                        </td>
                        <!-- /ko -->
                        <!-- ko if: !siteSupportsFuel -->
                        <td colspan="2">n/a</td>
                        <!-- /ko -->
                        <!-- /ko -->
                    </tr>
                    <tr data-bind="attr:{id: ('AjaxCollapseCompetitorsforsite' + SiteId)}" class="panel-collapse collapse" role="tabpanel">
                        <td colspan="12" xalign="right" style="background-color: grey">
                            <table class="competitorTable table-striped table-hover">
                                <thead>
                                    <tr rowspan="2">
                                        <th><span>Brand</span></th>
                                        <th><span>Marker</span></th>
                                        <th><span>Drive-Time</span></th>
                                        <th><span>Cat No.</span></th>

                                        <th colspan="2" class="tblHighlight">
                                            <span class="fuelHeaderGroup">&nbsp;Unleaded&nbsp;</span>
                                        </th>
                                        <th colspan="2"><span class="fuelHeaderGroup">&nbsp;Diesel&nbsp;</span></th>
                                        <th colspan="2" class="tblHighlight"><span class="fuelHeaderGroup">&nbsp;Super Unleaded&nbsp;</span></th>
                                    </tr>
                                    <tr>
                                        <th colspan="4"></th>
                                        <th class="tblHighlight"><span>Yesterday</span></th>
                                        <th class="tblHighlight"><span>Today</span></th>
                                        <th><span>Yesterday</span></th>
                                        <th><span>Today</span></th>
                                        <th class="tblHighlight"><span>Yesterday</span></th>
                                        <th class="tblHighlight"><span>Today</span></th>

                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- ko if: loadingCompetitors() -->
                                    <tr>
                                        <td colspan="10" class="noSiteData">loading... please wait</td>
                                    </tr>
                                    <!-- /ko -->
                                    <!-- ko if: !loadingCompetitors() -->
                                    <!-- ko if: !hasCompetitors() -->
                                    <tr>
                                        <td colspan="10" class="noSiteData">Sorry, no competitors available</td>
                                    </tr>
                                    <!-- /ko -->
                                    <!-- ko if: hasCompetitors() -->
                                    <!-- ko foreach: competitors -->
                                    <tr>
                                        <td><span data-bind="text: Brand"></span></td>
                                        <td><span data-bind="text: StoreName"></span></td>
                                        <td><span data-bind="text: DriveTime"></span></td>
                                        <td><span data-bind="text: CatNo"></span></td>

                                        <!-- ko foreach: FuelPricesToDisplay -->
                                        <!-- ko if: siteSupportsFuel -->
                                        <td><span data-bind="text: FuelPrice.YestPrice"></span></td>
                                        <td class="tblHighlight"><span data-bind="text: FuelPrice.TodayPrice"></span></td>
                                        <!-- /ko -->
                                        <!-- ko if: !siteSupportsFuel -->
                                        <td colspan="2">n/a</td>
                                        <!-- /ko -->
                                        <!-- /ko -->
                                    </tr>
                                    <!-- /ko -->
                                    <!-- /ko -->
                                    <!-- /ko -->
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    <!-- /ko -->
                </tbody>
                <tbody data-bind="cvisible: !$root.dataAvailable" style="visibility: hidden; display: none">
                    <tr>
                        <td colspan="12" class="noSiteData">Sorry, no site data available</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </form>
</div>

<br />

<script type="text/javascript">
    require(["SitePricing"], function (prices) {
        prices.go();
    });
</script>
