@model  JsPlc.Ssc.PetrolPricing.Models.ViewModels.SiteEmailImportResultViewModel
@{
    ViewBag.Title = "Upload Site Emails";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .step-number {
    font-size: 200%;
    color: #999;
    background-color: #eee;
    border-radius: 2em;
    display: inline-block;
    width: 3em;
    line-height: 1.5em;
    text-align: center;
    }

    .step-number:before {
        content: 'Step';
        font-size: 50%;
        position: relative;
        top: -0.25em;
        left: -0.25em;
    }

    .row-success {display: none;}
</style>

<h1><i class="fa fa-at"></i> Upload Site Email Addresses</h1>


@if(Model.Status.ErrorMessage != "")
{
    <div class="alert alert-danger font125pc">
        <i class="fa fa-warning"></i> Error: @(Model.Status.ErrorMessage)
    </div>
}
@if(Model.Status.SuccessMessage != "")
{
    <div class="alert alert-success font125pc">
        <i class="fa fa-check"></i> Success: @(Model.Status.SuccessMessage)
    </div>
}

@if (Model.Row.Any())
{
    <br />
    <div class="row">
        <div class="col-md-4 col-md-offset-4 text-center">
            <strong class="font125pc" id="spnShowingXofY">Showing</strong>
        </div>

        <div class="col-md-4">
            <label>Row filters: </label>
            <div class="btn-group">
                <button type="button" id="btnShowSuccess" class="btn btn-default btn-sm" data-infotip="Show or Hide the [b]Successful[/b] rows"><i class="fa fa-check"></i> Success <span class="badge" id="spnSuccessful"></span></button>
                <button type="button" id="btnShowErrors" class="btn btn-primary btn-sm" data-infotip="Show or Hide the [b]Errors[/b] rows"><i class="fa fa-times"> </i> Errors <span class="badge" id="spnErrors"></span></button>
            </div>
            <button type="button" id="btnShowAll" margin-left: 2em; class="btn btn-warning btn-sm" data-infotip="Show [b]all[/b] rows"><i class="fa fa-eraser"></i> Show all</button>
        </div>
    </div>
    <br />


<div class="" style="max-height: 500px; overflow: auto;">
<table id="RowStatusTable" class="table table-condensed table-striped">
    <thead>
        <tr>
            <th>Row</th>
            <th>StoreNo</th>
            <th>StoreName</th>
            <th>EmailAddress</th>
            <th>CatNo</th>
            <th>PfNo</th>
            <th>Success</th>
            <th>Message</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var row in Model.Row)
        {
            var rowClass = row.IsSuccess ? "row-success" : "row-error";
        <tr class="@(rowClass)">
            <td>@(row.RowNumber)</td>
            <td>@(row.StoreNo)</td>
            <td>@(row.StoreName)</td>
            <td>@(row.EmailAddress)</td>
            <td>@(row.CatNo)</td>
            <td>@(row.PfsNo)</td>
            <td>@if (row.IsSuccess)
            {
                <span class="text-success"><i class="fa fa-check"></i> Yes</span>
            }
            else
            {
                <span class="text-danger"><i class="fa fa-times"></i> No</span>
            }
            </td>
            <td>
                <strong>@(row.Message)</strong>
            </td>
        </tr>
        }
    </tbody>
</table>
</div>
}

@if (Model.Row.Any())
{
    <br />
    <div class="row">
        <div class="col-md-12 text-center">
            <a href="@Url.Action("UploadSiteEmails", "Sites")" class="btn btn-primary" >Upload another file</a>
        </div>
    </div>
} else { 
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="alert alert-warning no-margin">
                <i class="fa fa-info-circle"></i> <strong>Note:</strong> Uploading a file automatically turns <strong>OFF</strong> the use of <strong>LIVE</strong> email addresses and the <strong>Test Email Addresses</strong> will be used instead.<br />
                After uploading the email addresses you should review them and re-enable them via the <a class="page-link" href="@Url.Action("Index", "Settings")" data-infotip="View the [b]Settings page [/b]">Settings page</a>.
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="alert alert-info">
                <i class="fa fa-smile-o"></i> <strong>Tip:</strong> You can also load the <strong>CatNo</strong> and <strong>PfsNo</strong> for any Site which has a <strong>StoreNo</strong>.
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            <div class="panel panel-success">
                <div class="panel-heading">
                    <h4><i class="fa fa-upload"></i> Upload a Site Email File</h4>
                </div>
                <div class="panel-body">
                    <form action="" method="post" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-2">
                                <span class="step-number">1</span>
                            </div>

                            <div class="col-md-3">
                                <span class="btn btn-danger btn-file" id="FileButton" data-infotip="Please select the [b]Excel[/b] file to import">
                                    <i class="fa fa-file"></i>
                                    Select file...
                                    <input type="file" name="file" id="file" class="inputfile" accept=".xls, .xlsx" />
                                </span>
                            </div>

                            <div class="col-md-7">
                                <strong id="divPleaseSelect" class="text-danger"><i class="fa fa-arrow-left"></i> Please select a file</strong>
                                <strong id="divSelected" class="text-success" style="display:none;"><i class="fa fa-check"></i> <span id="spnSelectedFile" class="font125pc"></span></strong>
                            </div>
                        </div>
                        <hr />

                        <div id="divStep2" class="hide">
                            <div class="row" >
                                <div class="col-md-2">
                                    <span class="step-number">2</span>
                                </div>
                                <div class="col-md-10">
                                    <h4>Choose which fields to import</h4>
                                    <div class="indent">
                                        <label data-infotip-dock="below" data-infotip="Check this to import the [b]PfsNo[/b]">
                                            <input type="checkbox" id="ImportPfsNo" name="ImportPfsNo" value="1" />
                                            Import the <strong>PfsNo</strong>
                                        </label><br />

                                        <label data-infotip-dock="below" data-infotip="Check this to import the [b]CatNo[/b]">
                                            <input type="checkbox" id="ImportCatNo" name="ImportCatNo" value="1" />
                                            Import the <strong>CatNo</strong>
                                        </label><br />
                                    </div>

                                    <h4>Fix missing StoreNo</h4>
                                    <div class="indent">
                                        <label data-infotip-dock="below" data-infotip="Check this to Import the [b]StoreNo[/b] [br /]by matching on the exisiting [u]CatNo[/u]">
                                            <input type="checkbox" id="ImportStoreNoUsingCatNo" name="ImportStoreNoUsingCatNo" value="1" />
                                            Import <strong>StoreNo</strong> by matching the <strong>CatNo</strong>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <hr />
                        </div>

                        <div id="divStep3" class="hide">
                            <div class="row">
                                <div class="col-md-2">
                                    <span class="step-number">2</span>
                                </div>
                                <div class="col-md-10">
                                    <h4>Override warnings</h4>
                                    <div class="indent">
                                        <label data-infotip-dock="below" data-infotip="Check this if you want to allow different Stores to [b]share the same Email Address[/b]">
                                            <input type="checkbox" id="AllowSitesToShareEmails" name="AllowSitesToShareEmails" value="1" />
                                            Allow Emails to be shared amongst different stores
                                        </label><br />
                                    </div>
                                </div>
                            </div>
                            <hr />
                        </div>

                        <div id="divStep4" class="hide">
                            <div class="row" >
                                <div class="col-md-2">
                                    <span class="step-number">3</span>
                                </div>
                                <div class="col-md-10">
                                    <button type="submit" id="UploadFileButton" class="btn btn-primary" data-infotip="Upload the file and begin the [b]Import[/b]"><i class="fa fa-upload"></i> Upload file</button>
                                </div>
                            </div>
                        </div>  
                    </form>
                </div>
            </div>
           </div>
    </div>
}

<div class="row newline">
    <div class="col-md-1">
        <a class="btn btn-default" href="@Url.Action("SiteEmails", "Sites")"><i class="fa fa-backward"></i> Back to list</a>
    </div>
</div>
<script>
    require(["jquery", "busyloader", "notify", "infotips"],
        function ($, busyloader, notify, infotips) {

            var state = {
                showErrors: true,
                showSuccess: false
            };

            function uploadButtonClick() {
                busyloader.show({
                    message: 'Importing Email Addresses. Please wait...',
                    showtime: 2000,
                    dull: true
                });
            };

            function fileChanged() {
                var path = $('#file').val(),
                    step2 = $('#divStep2'),
                    step3 = $('#divStep3'),
                    step4 = $('#divStep4'),
                    fileButton = $('#FileButton'),
                    pleaseSelect = $('#divPleaseSelect'),
                    selected = $('#divSelected'),
                    spnSelectedFile = $('#spnSelectedFile'),
                    alerts = $('.alert');

                alerts.hide();

                if (/\S/.test(path)) {
                    fileButton.removeClass('btn-danger').addClass('btn-success');
                    step2.delay(300).fadeIn(1000);
                    step3.delay(600).fadeIn(1000);
                    step4.delay(900).fadeIn(1000);
                    spnSelectedFile.html(path.split('\\').pop());
                    pleaseSelect.hide();
                    selected.show();
                }
                else {
                    fileButton.removeClass('btn-success').addClass('btn-danger');
                    step2.hide();
                    step3.hide();
                    step4.hide();
                    pleaseSelect.show();
                    selected.hide();
                    filename.removeClass('text-success').addClass('text-danger').html('')
                }
            };

            function filterRows() {
                var rows = $('#RowStatusTable > tbody > tr'),
                    row,
                    i,
                    visible,
                    isSuccess,
                    isError,
                    counts = {
                        total: 0,
                        visible: 0,
                        hidden: 0,
                        errors: 0,
                        success: 0
                    };

                for (i = 0; i < rows.length; i++) {
                    row = $(rows[i]);
                    isSuccess = row.hasClass('row-success');
                    isError = row.hasClass('row-error');

                    visible = (isSuccess && state.showSuccess)
                        || (isError && state.showErrors);

                    if (visible) {
                        row.show();
                        counts.visible++;
                    }
                    else {
                        row.hide();
                        counts.hidden++;
                    }

                    if (isSuccess)
                        counts.success++;
                    if (isError)
                        counts.errors++;

                    counts.total++;
                }

                $('#spnSuccessful').html(counts.success);
                $('#spnErrors').html(counts.errors);
                $('#spnShowingXofY').html('Showing ' + counts.visible + ' of ' + counts.total);
            };

            function redrawToggleButtons() {
                drawButtonState('#btnShowSuccess', state.showSuccess);
                drawButtonState('#btnShowErrors', state.showErrors);
            };

            function drawButtonState(sel, active) {
                var btn = $(sel);
                if (active)
                    btn.removeClass('btn-default').addClass('btn-primary');
                else
                    btn.removeClass('btn-primary').addClass('btn-default');
            };

            function commonToggleState(opts) {
                var newState = !state[opts.state];
                state[opts.state] = newState;

                if (newState)
                    notify.info(opts.showing);
                else
                    notify.info(opts.hiding);

                filterRows();
                redrawToggleButtons();
            };

            function toggleShowSuccess() {
                commonToggleState({
                    state: 'showSuccess',
                    showing: 'Showing successful rows',
                    hiding: 'Hiding successful rows'
                });
            };

            function toggleShowErrors() {
                commonToggleState({
                    state: 'showErrors',
                    showing: 'Showing error rows',
                    hiding: 'Hiding error rows'
                });
            };

            function showAll() {
                state.showErrors = true;
                state.showSuccess = true;
                redrawToggleButtons();
                notify.info('Showing all Imported rows');
            };

            function replaceHideClass() {
                $('.hide').each(function () {
                    $(this).hide().removeClass('hide');
                });
            };

            function docReady() {
                replaceHideClass();

                $('#UploadFileButton').click(uploadButtonClick);
                $('#file').on('change', fileChanged);

                $('#btnShowSuccess').off().click(toggleShowSuccess);
                $('#btnShowErrors').off().click(toggleShowErrors);
                $('#btnShowAll').off().click(showAll);
                filterRows();
            };

            $(docReady);


        });
</script>